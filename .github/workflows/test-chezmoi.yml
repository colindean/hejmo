name: Test Chezmoi Integration

on:
  push:

permissions: {}

jobs:
  test-chezmoi:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Fetch full history for git mv tracking
          persist-credentials: false
      
      - name: Install chezmoi
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Install latest chezmoi from GitHub releases using gh CLI
          CHEZMOI_VERSION=$(gh api /repos/twpayne/chezmoi/releases/latest --jq '.tag_name | gsub("v"; "")')
          echo "Installing chezmoi version ${CHEZMOI_VERSION}"
          cd /tmp
          curl -sfL "https://github.com/twpayne/chezmoi/releases/download/v${CHEZMOI_VERSION}/chezmoi_${CHEZMOI_VERSION}_linux_amd64.tar.gz" | tar -xz
          sudo install chezmoi /usr/local/bin/
          chezmoi --version
      
      - name: Setup Bats and bats libs
        id: setup-bats
        uses: bats-core/bats-action@42fcc8700f773c075a16a90eb11674c0318ad507 # 3.0.1
      
      - name: Initialize chezmoi with repository
        run: |
          # Initialize chezmoi with the current branch
          # Extract branch name from GITHUB_REF (refs/heads/branch-name)
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Initializing chezmoi with branch: ${BRANCH_NAME}"
          
          # For local testing, we'll use the checked out files directly
          # In a real scenario, this would use the GitHub URL
          if [ -n "${GITHUB_REPOSITORY}" ]; then
            REPO_URL="https://github.com/${GITHUB_REPOSITORY}.git"
            echo "Using repository URL: ${REPO_URL}"
            
            # Remove any existing chezmoi directory
            rm -rf ~/.local/share/chezmoi
            
            # Initialize with the repository and branch
            chezmoi init --apply "${REPO_URL}" --branch "${BRANCH_NAME}"
          else
            # Local testing fallback
            echo "Running in local mode, using checked out files"
            mkdir -p ~/.local/share
            ln -s "${GITHUB_WORKSPACE}/home" ~/.local/share/chezmoi
            chezmoi init --apply
          fi

      - name: Run Chezmoi BATS tests
        shell: bash
        env:
          BATS_LIB_PATH: ${{ steps.setup-bats.outputs.lib-path }}
          TERM: xterm
        run: |
          bats -p --print-output-on-failure tests/test_chezmoi.bats

      - name: Display chezmoi status
        if: always()
        run: |
          echo "=== Chezmoi Status ==="
          chezmoi status || true
          echo ""
          echo "=== Managed Files ==="
          chezmoi managed || true
          echo ""
          echo "=== Home Directory Files ==="
          ls -la ~ | grep -E "^\." | head -20 || true

      - name: Run bash profile BATS tests
        shell: bash
        env:
          BATS_LIB_PATH: ${{ steps.setup-bats.outputs.lib-path }}
          TERM: xterm
        run: |
          bats -p --print-output-on-failure --separate-stderr tests/test_bash_startup.bats
